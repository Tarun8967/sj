<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SJ TRADERS - Attendance Portal</title>
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --warning: #f1c40f;
            --leave: #f39c12;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        
        /* Layout */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        
        /* Auth Screens */
        .auth-container { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .auth-container h2 { text-align: center; color: var(--primary); margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
        .btn-primary { background-color: var(--secondary); color: white; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-secondary { background-color: #95a5a6; color: white; margin-top: 10px; }
        .switch-link { text-align: center; margin-top: 15px; display: block; cursor: pointer; color: var(--secondary); }

        /* Dashboard */
        header { background: var(--primary); color: white; padding: 15px 0; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .nav-btn { background: none; border: 1px solid white; color: white; padding: 5px 15px; cursor: pointer; margin-left: 10px; }
        .nav-btn:hover { background: rgba(255,255,255,0.2); }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr 3fr; gap: 20px; margin-top: 20px; }
        
        /* Sidebar Controls */
        .controls-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .time-display { font-size: 2em; font-weight: bold; color: var(--dark); margin: 10px 0; }
        .action-btn { padding: 15px; width: 100%; margin-bottom: 10px; font-size: 1.1em; }
        .btn-checkin { background-color: var(--success); color: white; }
        .btn-checkout { background-color: var(--accent); color: white; }
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; }
        .status-present { background: #d5f5e3; color: var(--success); }
        .status-absent { background: #fadbd8; color: var(--accent); }
        .status-leave { background: #fdebd0; color: var(--leave); }
        .status-out { background: #fcf3cf; color: var(--warning); }

        /* Main Content */
        .main-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: 600; color: #7f8c8d; }
        .tab.active { color: var(--secondary); border-bottom: 3px solid var(--secondary); }
        
        /* Toolbar */
        .toolbar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; align-items: center; justify-content: space-between; }
        .toolbar-group { display: flex; gap: 10px; align-items: center; }
        .btn-export { background-color: #2ecc71; color: white; padding: 8px 15px; font-size: 14px; display: flex; align-items: center; gap: 5px; }
        .btn-export.pdf { background-color: #e74c3c; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: var(--dark); }
        tr:hover { background-color: #f1f1f1; }
        .action-icon { cursor: pointer; font-size: 1.2em; margin-left: 8px; }
        .admin-edited-tag { font-size: 0.7em; background: #e67e22; color: white; padding: 2px 5px; border-radius: 3px; margin-left: 5px; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 500px; max-width: 95%; max-height: 90vh; overflow-y: auto; }
        
        /* Calendar Styles */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day-header { font-weight: bold; text-align: center; padding: 5px; background: #f0f0f0; }
        .calendar-day { 
            height: 60px; border: 1px solid #eee; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; cursor: pointer; position: relative;
        }
        .calendar-day span { font-size: 12px; }
        .day-present { background-color: #d5f5e3; border-color: #27ae60; }
        .day-absent { background-color: #fadbd8; border-color: #c0392b; }
        .day-leave { background-color: #fdebd0; border-color: #f39c12; }
        .day-future { background-color: #f9f9f9; cursor: default; }

        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .toolbar-group { justify-content: space-between; }
        }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="auth-container">
        <h2>SJ TRADERS Login</h2>
        <form id="login-form">
            <div class="form-group">
                <label>Email ID</label>
                <input type="email" id="login-email" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="login-password" required>
            </div>
            <button type="submit" class="btn btn-primary">Sign In</button>
            <span class="switch-link" onclick="showRegister()">New Staff? Register Here</span>
        </form>
    </div>

    <!-- REGISTER SCREEN -->
    <div id="register-screen" class="auth-container hidden">
        <h2>Staff Registration</h2>
        <form id="register-form">
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="reg-name" required>
            </div>
            <div class="form-group">
                <label>Designation</label>
                <input type="text" id="reg-designation" placeholder="e.g. Salesman, Accountant" required>
            </div>
            <div class="form-group">
                <label>Mobile No</label>
                <input type="tel" id="reg-mobile" required>
            </div>
            <div class="form-group">
                <label>Email ID</label>
                <input type="email" id="reg-email" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="reg-password" required>
            </div>
            <div class="form-group">
                <label>Confirm Password</label>
                <input type="password" id="reg-confirm" required>
            </div>
            <button type="submit" class="btn btn-primary">Register</button>
            <span class="switch-link" onclick="showLogin()">Already Registered? Login</span>
        </form>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
        <header>
            <div class="container header-content">
                <h2 id="user-greeting">Welcome, Staff</h2>
                <button onclick="logout()" class="nav-btn">Logout</button>
            </div>
        </header>

        <div class="container dashboard-grid">
            <!-- Sidebar / Action Panel -->
            <div class="controls-card">
                <h3>Today's Status</h3>
                <div id="clock" class="time-display">00:00:00</div>
                <div id="today-date" style="margin-bottom: 20px; color: #7f8c8d;"></div>
                
                <div id="attendance-actions">
                    <button id="btn-in" onclick="markAttendance('in')" class="btn action-btn btn-checkin">Check In</button>
                    <button id="btn-out" onclick="markAttendance('out')" class="btn action-btn btn-checkout hidden">Check Out</button>
                </div>
                <div id="status-message" style="margin-top:15px; font-weight:bold;"></div>
            </div>

            <!-- Main Panel -->
            <div class="main-card">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('list')">Attendance List</div>
                    <div class="tab" onclick="switchTab('statement')">Statement</div>
                    <div class="tab" onclick="switchTab('analytics')">Analytics</div>
                </div>

                <!-- Tab 1: List -->
                <div id="tab-list">
                    <div class="toolbar">
                        <div class="toolbar-group">
                            <input type="date" id="filter-date" onchange="loadAttendanceData()">
                            <button onclick="loadAttendanceData()" class="nav-btn" style="background:var(--secondary); border:none;">Refresh</button>
                        </div>
                    </div>
                    
                    <div style="overflow-x:auto;">
                        <table id="attendance-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Designation</th>
                                    <th>In Time</th>
                                    <th>Out Time</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab 2: Statement -->
                <div id="tab-statement" class="hidden">
                    <div class="toolbar">
                        <div class="toolbar-group">
                            <label>From:</label>
                            <input type="date" id="stmt-start">
                            <label>To:</label>
                            <input type="date" id="stmt-end">
                            <button onclick="generateStatement()" class="btn-primary" style="padding: 8px 15px; border-radius: 4px;">Generate</button>
                        </div>
                        <div class="toolbar-group">
                            <button onclick="exportStatementExcel()" class="btn btn-export">
                                <span>üìä</span> Excel
                            </button>
                            <button onclick="exportStatementPDF()" class="btn btn-export pdf">
                                <span>üìÑ</span> PDF
                            </button>
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table id="statement-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Designation</th>
                                    <th>Total Days</th>
                                    <th>Present</th>
                                    <th>Absent</th>
                                    <th>Leave</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" style="text-align:center;">Select dates and click Generate</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab 3: Analytics -->
                <div id="tab-analytics" class="hidden">
                    <div class="toolbar">
                        <div class="toolbar-group">
                            <label style="margin-right:5px; font-weight:600;">View:</label>
                            <select id="analytics-metric" style="padding:8px; border-radius:4px; border:1px solid #ccc; margin-right:10px;" onchange="renderChart()">
                                <option value="present">Present Days</option>
                                <option value="absent">Absent Days</option>
                                <option value="leave">Leave Days</option>
                                <option value="worktime">Work Hours</option>
                            </select>
                            
                            <label style="margin-right:5px; font-weight:600;">From:</label>
                            <input type="date" id="analytics-start" style="margin-right:10px;">
                            <label style="margin-right:5px; font-weight:600;">To:</label>
                            <input type="date" id="analytics-end" style="margin-right:10px;">
                            
                            <button onclick="renderChart()" class="btn-primary" style="padding: 8px 15px; border-radius: 4px;">Generate Graph</button>
                        </div>
                        <div class="toolbar-group">
                            <button onclick="setAnalyticsRange('month')" class="btn btn-secondary" style="margin:0; font-size: 0.9em;">This Month</button>
                            <button onclick="setAnalyticsRange('year')" class="btn btn-secondary" style="margin:0; margin-left:5px; font-size: 0.9em;">This Year</button>
                        </div>
                    </div>
                    <div style="height: 400px; margin-top:20px;">
                        <canvas id="workChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CALENDAR MODAL -->
    <div id="calendar-modal" class="modal hidden">
        <div class="modal-content">
            <div class="calendar-header">
                <h3 id="cal-user-name" style="margin:0;">User Calendar</h3>
                <div>
                    <button class="nav-btn" style="background:#ddd; color:black;" onclick="changeCalMonth(-1)">&lt;</button>
                    <span id="cal-month-year" style="font-weight:bold; margin:0 10px;">Month Year</span>
                    <button class="nav-btn" style="background:#ddd; color:black;" onclick="changeCalMonth(1)">&gt;</button>
                </div>
                <button onclick="document.getElementById('calendar-modal').classList.add('hidden')" style="background:none; border:none; font-size:1.2em; cursor:pointer;">&times;</button>
            </div>
            
            <div id="calendar-grid" class="calendar-grid"></div>
            <div style="margin-top:15px; font-size:0.9em; color:#666;">
                <span style="display:inline-block; width:10px; height:10px; background:#d5f5e3;"></span> Present
                <span style="display:inline-block; width:10px; height:10px; background:#fadbd8; margin-left:10px;"></span> Absent
                <span style="display:inline-block; width:10px; height:10px; background:#fdebd0; margin-left:10px;"></span> Leave
            </div>
            <p id="admin-cal-hint" class="hidden" style="color: var(--secondary); font-size: 0.9em; margin-top: 5px;">* Click on an Absent day to convert to Leave</p>
        </div>
    </div>

    <!-- LEAVE REASON MODAL -->
    <div id="leave-modal" class="modal hidden">
        <div class="modal-content" style="width: 350px;">
            <h3>Mark as Leave</h3>
            <p id="leave-date-display" style="color: #666; margin-bottom: 10px;"></p>
            <input type="hidden" id="leave-target-date">
            <div class="form-group">
                <label>Reason for Leave</label>
                <textarea id="leave-reason" rows="3" placeholder="e.g. Sick Leave, Family Emergency"></textarea>
            </div>
            <button onclick="confirmLeaveConversion()" class="btn btn-primary">Confirm & Save</button>
            <button onclick="document.getElementById('leave-modal').classList.add('hidden')" class="btn btn-secondary">Cancel</button>
        </div>
    </div>

    <!-- ADMIN EDIT MODAL -->
    <div id="edit-modal" class="modal hidden">
        <div class="modal-content" style="width: 400px;">
            <h3>Edit Attendance (Admin)</h3>
            <input type="hidden" id="edit-doc-id">
            <div class="form-group">
                <label>Check In Time</label>
                <input type="time" id="edit-in">
            </div>
            <div class="form-group">
                <label>Check Out Time</label>
                <input type="time" id="edit-out">
            </div>
            <div class="form-group">
                <label>Status Override</label>
                <select id="edit-status">
                    <option value="Present">Present</option>
                    <option value="Absent">Absent</option>
                    <option value="Leave">Leave</option>
                    <option value="On Duty">On Duty</option>
                </select>
            </div>
            <button onclick="saveAdminEdit()" class="btn btn-primary">Save Changes</button>
            <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBbGU4WQbnPNzV4VzqudVPKZuLpB4kYQts",
            authDomain: "sj-treders.firebaseapp.com",
            projectId: "sj-treders",
            storageBucket: "sj-treders.firebasestorage.app",
            messagingSenderId: "2993199655",
            appId: "1:2993199655:web:c699c3c6721e0c6a3f0c02"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        let currentUser = null;
        let userData = null;
        let chartInstance = null;
        let currentCalDate = new Date();
        let currentCalUser = null;

        // --- HELPER: LOCAL DATE FORMATTER ---
        const formatDateLocal = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        // --- AUTH & SETUP ---
        
        window.showRegister = () => {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('register-screen').classList.remove('hidden');
        };

        window.showLogin = () => {
            document.getElementById('register-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        };

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const confirm = document.getElementById('reg-confirm').value;
            const name = document.getElementById('reg-name').value;
            const desig = document.getElementById('reg-designation').value;
            const mobile = document.getElementById('reg-mobile').value;

            if(password !== confirm) return alert("Passwords do not match");

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", cred.user.uid), {
                    name: name,
                    designation: desig,
                    mobile: mobile,
                    email: email,
                    role: 'staff'
                });
                alert("Registered Successfully! Logging in...");
            } catch (error) {
                alert(error.message);
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value);
            } catch (error) {
                alert("Login Failed: " + error.message);
            }
        });

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    document.getElementById('user-greeting').innerText = `Welcome, ${userData.name} (${userData.role === 'admin' ? 'Admin' : 'Staff'})`;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('register-screen').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    
                    startClock();
                    checkTodayStatus();
                    loadAttendanceData();

                    // Set default dates
                    const today = formatDateLocal(new Date());
                    document.getElementById('stmt-end').value = today;
                    document.getElementById('analytics-end').value = today;
                    
                    const firstDay = new Date();
                    firstDay.setDate(1);
                    document.getElementById('stmt-start').value = formatDateLocal(firstDay);
                    document.getElementById('analytics-start').value = formatDateLocal(firstDay);
                }
            } else {
                currentUser = null;
                userData = null;
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        });

        // --- DASHBOARD CORE ---

        function startClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock').innerText = now.toLocaleTimeString();
                document.getElementById('today-date').innerText = now.toDateString();
            }, 1000);
        }

        async function checkTodayStatus() {
            const todayStr = formatDateLocal(new Date());
            const docId = `${currentUser.uid}_${todayStr}`;
            const docRef = doc(db, "attendance", docId);
            const docSnap = await getDoc(docRef);
            const btnIn = document.getElementById('btn-in');
            const btnOut = document.getElementById('btn-out');
            const statusMsg = document.getElementById('status-message');

            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.checkOut || data.status === 'Leave') {
                    btnIn.classList.add('hidden');
                    btnOut.classList.add('hidden');
                    statusMsg.innerHTML = `<span class="status-badge status-present">Day Completed: ${data.duration || data.status}</span>`;
                } else {
                    btnIn.classList.add('hidden');
                    btnOut.classList.remove('hidden');
                    statusMsg.innerHTML = `<span class="status-badge status-out">Currently Working</span>`;
                }
            } else {
                btnIn.classList.remove('hidden');
                btnOut.classList.add('hidden');
                statusMsg.innerText = "Please Check In";
            }
        }

        window.markAttendance = async (type) => {
            const now = new Date();
            const todayStr = formatDateLocal(now);
            const timeStr = now.toLocaleTimeString();
            const docId = `${currentUser.uid}_${todayStr}`;
            const docRef = doc(db, "attendance", docId);

            if (type === 'in') {
                await setDoc(docRef, {
                    uid: currentUser.uid,
                    name: userData.name,
                    designation: userData.designation,
                    date: todayStr,
                    checkIn: timeStr,
                    checkInTimestamp: now.getTime(),
                    checkOut: null,
                    duration: "0h 0m",
                    status: "Present",
                    adminEdited: false
                });
            } else {
                const docSnap = await getDoc(docRef);
                const data = docSnap.data();
                const durationMs = now.getTime() - data.checkInTimestamp;
                const hours = Math.floor(durationMs / 3600000);
                const minutes = Math.floor((durationMs % 3600000) / 60000);
                
                await updateDoc(docRef, {
                    checkOut: timeStr,
                    checkOutTimestamp: now.getTime(),
                    duration: `${hours}h ${minutes}m`
                });
            }
            checkTodayStatus();
            loadAttendanceData();
        };

        // --- MAIN LIST VIEW ---
        
        window.loadAttendanceData = async () => {
            const tableBody = document.querySelector('#attendance-table tbody');
            tableBody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
            
            const dateFilter = document.getElementById('filter-date').value || formatDateLocal(new Date());
            document.getElementById('filter-date').value = dateFilter;
            
            const usersSnapshot = await getDocs(collection(db, "users"));
            const allUsers = [];
            usersSnapshot.forEach(doc => allUsers.push({id: doc.id, ...doc.data()}));

            const q = query(collection(db, "attendance"), where("date", "==", dateFilter));
            const attSnapshot = await getDocs(q);
            const attendanceMap = {};
            attSnapshot.forEach(doc => {
                attendanceMap[doc.data().uid] = { id: doc.id, ...doc.data() };
            });

            let html = '';
            
            allUsers.forEach(user => {
                const record = attendanceMap[user.id];
                let inTime = '-', outTime = '-', duration = '-', status = '<span class="status-badge status-absent">Absent</span>';
                let editBtn = '';
                let statusText = 'Absent';

                if (record) {
                    inTime = record.checkIn || '-';
                    outTime = record.checkOut || 'Working...';
                    duration = record.duration || '-';
                    statusText = record.status;
                    let badgeClass = 'status-present';
                    if(statusText === 'Absent') badgeClass = 'status-absent';
                    if(statusText === 'On Duty') badgeClass = 'status-out';
                    if(statusText === 'Leave') {
                        badgeClass = 'status-leave';
                        inTime = 'On Leave';
                        outTime = 'On Leave';
                    }
                    
                    status = `<span class="status-badge ${badgeClass}" title="${record.remarks || ''}">${statusText}</span>`;
                }

                if (userData && userData.role === 'admin') {
                    if(record) {
                        editBtn = `<span title="Edit" class="action-icon" style="color:var(--secondary);" onclick="openAdminEdit('${record.id}', '${record.checkIn}', '${record.checkOut}', '${statusText}')">‚úèÔ∏è</span>`;
                    }
                }
                
                // Calendar Icon
                const calBtn = `<span title="View Calendar" class="action-icon" style="color:#8e44ad;" onclick="openCalendar('${user.id}', '${user.name}')">üìÖ</span>`;

                html += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.designation}</td>
                        <td>${inTime}</td>
                        <td>${outTime}</td>
                        <td>${duration}</td>
                        <td>${status}</td>
                        <td>${calBtn} ${editBtn}</td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
        };

        // --- CALENDAR FEATURE ---

        window.openCalendar = (uid, name) => {
            currentCalUser = { uid, name };
            currentCalDate = new Date(); // Reset to today
            document.getElementById('cal-user-name').innerText = `${name}'s Calendar`;
            document.getElementById('calendar-modal').classList.remove('hidden');
            
            if(userData.role === 'admin') {
                document.getElementById('admin-cal-hint').classList.remove('hidden');
            } else {
                document.getElementById('admin-cal-hint').classList.add('hidden');
            }

            renderCalendar();
        };

        window.changeCalMonth = (dir) => {
            currentCalDate.setMonth(currentCalDate.getMonth() + dir);
            renderCalendar();
        };

        async function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = 'Loading...';
            
            const year = currentCalDate.getFullYear();
            const month = currentCalDate.getMonth();
            const monthName = currentCalDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            document.getElementById('cal-month-year').innerText = monthName;

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startStr = formatDateLocal(new Date(year, month, 1));
            const endStr = formatDateLocal(new Date(year, month, daysInMonth));

            // Query by UID only
            const q = query(collection(db, "attendance"), where("uid", "==", currentCalUser.uid));
            const snapshot = await getDocs(q);
            const records = {};
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.date >= startStr && data.date <= endStr) {
                    records[data.date] = data;
                }
            });

            let html = '';
            ['S','M','T','W','T','F','S'].forEach(d => html += `<div class="calendar-day-header">${d}</div>`);
            
            const firstDay = new Date(year, month, 1).getDay();
            for(let i=0; i<firstDay; i++) html += `<div></div>`;

            const today = new Date();
            const todayStr = formatDateLocal(today);

            for(let d=1; d<=daysInMonth; d++) {
                const dateObj = new Date(year, month, d);
                const dateStr = formatDateLocal(dateObj);
                const record = records[dateStr];
                
                let className = 'calendar-day ';
                let statusLabel = '';
                let isAbsent = false;

                if (record) {
                    if(record.status === 'Present') className += 'day-present';
                    else if(record.status === 'Leave') { className += 'day-leave'; statusLabel='Leave'; }
                    else if(record.status === 'Absent') { className += 'day-absent'; isAbsent = true; }
                    else if(record.status === 'On Duty') { className += 'day-leave'; statusLabel='Duty'; }
                } else {
                    if (dateStr < todayStr) {
                        className += 'day-absent'; // Past date, no record = Absent
                        isAbsent = true;
                    } else if (dateStr === todayStr) {
                         // Today with no record yet is technically absent/working, allow edit
                         className += 'day-absent'; 
                         isAbsent = true;
                    } else {
                        className += 'day-future';
                    }
                }

                let onClick = '';
                // Only allow Admin to edit 'Absent' days.
                if(userData.role === 'admin' && isAbsent) {
                    onClick = `onclick="initiateLeaveConversion('${dateStr}')"`;
                }

                // Tooltip construction
                let tooltip = statusLabel || (isAbsent ? 'Absent' : 'Present');
                if(record && record.remarks) {
                    tooltip += `\nReason: ${record.remarks}`;
                }

                html += `
                    <div class="${className}" ${onClick} title="${tooltip}">
                        <strong>${d}</strong>
                        <span>${statusLabel}</span>
                    </div>
                `;
            }
            grid.innerHTML = html;
        }

        // --- NEW LEAVE CONVERSION LOGIC ---
        window.initiateLeaveConversion = (dateStr) => {
            document.getElementById('leave-target-date').value = dateStr;
            document.getElementById('leave-date-display').innerText = `Date: ${dateStr}`;
            document.getElementById('leave-reason').value = ''; 
            document.getElementById('leave-modal').classList.remove('hidden');
        };

        window.confirmLeaveConversion = async () => {
            const dateStr = document.getElementById('leave-target-date').value;
            const reason = document.getElementById('leave-reason').value;

            if(!reason) return alert("Please enter a reason.");

            const docId = `${currentCalUser.uid}_${dateStr}`;
            
            try {
                await setDoc(doc(db, "attendance", docId), {
                    uid: currentCalUser.uid,
                    name: currentCalUser.name,
                    date: dateStr,
                    status: "Leave",
                    checkIn: "On Leave",
                    checkOut: "On Leave",
                    duration: "Leave",
                    remarks: reason,
                    adminEdited: true
                }, { merge: true });

                document.getElementById('leave-modal').classList.add('hidden');
                renderCalendar();
                loadAttendanceData(); // Refresh main list too
                alert("Updated to Leave successfully.");
            } catch (error) {
                console.error("Firebase Error:", error);
                if (error.code === 'permission-denied') {
                    alert("Permission Denied: You need to update your Firestore Rules. Check the console or ask your developer.");
                } else {
                    alert("Error updating leave: " + error.message);
                }
            }
        };

        // --- STATEMENT & REPORTING ---

        window.generateStatement = async () => {
            const start = document.getElementById('stmt-start').value;
            const end = document.getElementById('stmt-end').value;
            const tbody = document.querySelector('#statement-table tbody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Calculating...</td></tr>';

            if(!start || !end) return alert("Select start and end dates");

            const usersSnap = await getDocs(collection(db, "users"));
            const users = [];
            usersSnap.forEach(u => users.push({uid: u.id, ...u.data()}));

            const q = query(collection(db, "attendance"), where("date", ">=", start), where("date", "<=", end));
            const attSnap = await getDocs(q);
            
            const d1 = new Date(start);
            const d2 = new Date(end);
            const totalDays = Math.floor((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;

            const reportData = {};
            users.forEach(u => {
                reportData[u.uid] = { 
                    name: u.name, 
                    desig: u.designation, 
                    present: 0, 
                    leave: 0,
                };
            });

            attSnap.forEach(doc => {
                const data = doc.data();
                if(reportData[data.uid]) {
                    if(data.status === 'Present' || data.status === 'On Duty') reportData[data.uid].present++;
                    else if(data.status === 'Leave') reportData[data.uid].leave++;
                }
            });

            let html = '';
            Object.values(reportData).forEach(u => {
                const absent = totalDays - (u.present + u.leave);
                html += `
                    <tr>
                        <td>${u.name}</td>
                        <td>${u.desig}</td>
                        <td>${totalDays}</td>
                        <td>${u.present}</td>
                        <td style="color:red; font-weight:bold;">${Math.max(0, absent)}</td>
                        <td>${u.leave}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        };

        window.exportStatementExcel = () => {
            const table = document.getElementById("statement-table");
            const start = document.getElementById('stmt-start').value;
            const end = document.getElementById('stmt-end').value;
            const wb = XLSX.utils.table_to_book(table, {sheet: "Sheet1"});
            XLSX.writeFile(wb, `SJ_Traders_Statement_${start}_to_${end}.xlsx`);
        };

        window.exportStatementPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const start = document.getElementById('stmt-start').value;
            const end = document.getElementById('stmt-end').value;

            doc.text(`SJ TRADERS - Attendance Statement`, 14, 15);
            doc.setFontSize(10);
            doc.text(`Period: ${start} to ${end}`, 14, 22);

            doc.autoTable({ html: '#statement-table', startY: 30 });
            doc.save(`SJ_Traders_Statement_${start}_to_${end}.pdf`);
        };

        // --- ADMIN EDIT LOGIC ---

        window.openAdminEdit = (docId, checkIn, checkOut, status) => {
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-doc-id').value = docId;
            document.getElementById('edit-status').value = status;
        };

        window.closeModal = () => document.getElementById('edit-modal').classList.add('hidden');

        window.saveAdminEdit = async () => {
            const docId = document.getElementById('edit-doc-id').value;
            const newIn = document.getElementById('edit-in').value;
            const newOut = document.getElementById('edit-out').value;
            const newStatus = document.getElementById('edit-status').value;

            let newDuration = "Edited";
            if (newIn && newOut) {
                const d1 = new Date(`2000-01-01T${newIn}`);
                const d2 = new Date(`2000-01-01T${newOut}`);
                const diff = d2 - d1;
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                newDuration = `${h}h ${m}m`;
            }

            const updateData = { status: newStatus, adminEdited: true };
            if(newIn) updateData.checkIn = newIn; 
            if(newOut) { updateData.checkOut = newOut; updateData.duration = newDuration; }

            await updateDoc(doc(db, "attendance", docId), updateData);
            closeModal();
            loadAttendanceData();
            alert("Record Updated");
        };

        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            ['list', 'statement', 'analytics'].forEach(id => {
                const el = document.getElementById(`tab-${id}`);
                if(id === tabName) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
            
            if (tabName === 'analytics') renderChart();
        };

        // --- ANALYTICS ---

        window.setAnalyticsRange = (type) => {
            const now = new Date();
            const end = formatDateLocal(now);
            let start = end;

            if (type === 'month') {
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                start = formatDateLocal(firstDay);
            } else if (type === 'year') {
                const firstDay = new Date(now.getFullYear(), 0, 1);
                start = formatDateLocal(firstDay);
            }

            document.getElementById('analytics-start').value = start;
            document.getElementById('analytics-end').value = end;
            renderChart();
        };

        // Helper to safely parse "Xh Ym" even if it says "Leave" or null
        function parseDuration(durationStr) {
            if (!durationStr || typeof durationStr !== 'string') return 0;
            if (durationStr.includes('Leave') || durationStr.includes('On Leave')) return 0;
            
            const hMatch = durationStr.match(/(\d+)h/);
            const mMatch = durationStr.match(/(\d+)m/);
            
            let h = hMatch ? parseInt(hMatch[1]) : 0;
            let m = mMatch ? parseInt(mMatch[1]) : 0;
            return h + (m / 60);
        }

        window.renderChart = async () => {
            const ctx = document.getElementById('workChart').getContext('2d');
            const metric = document.getElementById('analytics-metric').value; // present, absent, leave, worktime
            const start = document.getElementById('analytics-start').value;
            const end = document.getElementById('analytics-end').value;

            if(!start || !end) return;

            // 1. Get all users (to include everyone even if they have 0 attendance)
            const usersSnap = await getDocs(collection(db, "users"));
            const userDataMap = {};
            usersSnap.forEach(u => {
                userDataMap[u.id] = { name: u.data().name, count: 0 };
            });

            // 2. Get attendance within range
            const q = query(collection(db, "attendance"), where("date", ">=", start), where("date", "<=", end));
            const attSnap = await getDocs(q);

            // Calculate Total days in range for 'Absent' calculation
            const d1 = new Date(start);
            const d2 = new Date(end);
            const totalDaysInRange = Math.floor((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;

            attSnap.forEach(doc => {
                const data = doc.data();
                if(!userDataMap[data.uid]) return; // Skip if user deleted

                if(metric === 'worktime') {
                    userDataMap[data.uid].count += parseDuration(data.duration);
                } else if(metric === 'present') {
                    if(data.status === 'Present' || data.status === 'On Duty') {
                        userDataMap[data.uid].count++;
                    }
                } else if(metric === 'leave') {
                    if(data.status === 'Leave') {
                        userDataMap[data.uid].count++;
                    }
                } else if(metric === 'absent') {
                    // For absent, we need to subtract present+leave from total days.
                    // So we FIRST count present/leave here, then convert at the end.
                     if(data.status === 'Present' || data.status === 'On Duty' || data.status === 'Leave') {
                        userDataMap[data.uid].count++; 
                        // Note: this 'count' is actually 'days NOT absent'. We will flip it later.
                    }
                }
            });

            const labels = [];
            const dataValues = [];
            const backgroundColors = [];
            const borderColors = [];

            let colorBase = 'rgba(52, 152, 219,'; // Blue for Worktime
            if(metric === 'present') colorBase = 'rgba(39, 174, 96,'; // Green
            if(metric === 'absent') colorBase = 'rgba(192, 57, 43,'; // Red
            if(metric === 'leave') colorBase = 'rgba(243, 156, 18,'; // Orange

            Object.values(userDataMap).forEach(u => {
                labels.push(u.name);
                
                let val = u.count;
                if(metric === 'absent') {
                    // Absent = Total Days - (Present + Leave)
                    // u.count currently holds (Present + Leave)
                    val = Math.max(0, totalDaysInRange - u.count);
                }
                
                if(metric === 'worktime') val = val.toFixed(1); // Round hours
                
                dataValues.push(val);
                backgroundColors.push(colorBase + ' 0.6)');
                borderColors.push(colorBase + ' 1)');
            });

            if (chartInstance) chartInstance.destroy();

            let labelText = 'Total Hours';
            if(metric === 'present') labelText = 'Days Present';
            if(metric === 'absent') labelText = 'Days Absent';
            if(metric === 'leave') labelText = 'Days on Leave';

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelText,
                        data: dataValues,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        };
    </script>
</body>
</html>
